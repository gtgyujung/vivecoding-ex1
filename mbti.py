import streamlit as st
import pandas as pd
import numpy as np

# 1. MBTI ìœ í˜•ë³„ ì„¤ëª… ë°ì´í„° (ì½”ë“œ ë‚´ì— ì •ì˜)
mbti_descriptions = {
    'ISTJ': 'ì±…ì„ê°ì´ ê°•í•˜ê³  í˜„ì‹¤ì ì´ë©°, ì›ë¦¬ì›ì¹™ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ë…¼ë¦¬ì ì¸ ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ISFJ': 'ìš©ê°í•œ ìˆ˜í˜¸ìí˜•ìœ¼ë¡œ, ì„±ì‹¤í•˜ê³  í—Œì‹ ì ì´ë©° ì¡°ìš©í•˜ê³  ë”°ëœ»í•œ ì‚¬ëŒì…ë‹ˆë‹¤.',
    'INFJ': 'í†µì°°ë ¥ì´ ë›°ì–´ë‚˜ê³  ì‚¬ëŒë“¤ì˜ ì„±ì¥ì— ê¸°ì—¬í•˜ëŠ”, ì„ ì˜ì˜ ì˜¹í˜¸ìì…ë‹ˆë‹¤.',
    'INTJ': 'ì§€ì‹ì— ëŒ€í•œ ê°ˆë§ì´ í¬ë©°, ìƒìƒë ¥ì´ í’ë¶€í•˜ê³  ì „ëµì ì¸ ì‚¬ê³ ë¥¼ í•˜ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ISTP': 'ë§ŒëŠ¥ ì¬ì£¼ê¾¼ìœ¼ë¡œ, ë…¼ë¦¬ì ì´ê³  í˜¸ê¸°ì‹¬ì´ ë§ìœ¼ë©° ë„êµ¬ë¥¼ ì˜ ë‹¤ë£¨ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ISFP': 'í˜¸ê¸°ì‹¬ ë§ì€ ì˜ˆìˆ ê°€í˜•ìœ¼ë¡œ, ë”°ëœ»í•˜ê³  ìœ ì—°í•˜ë©° ì˜ˆìˆ ì ì¸ ê°ê°ì„ ê°€ì§„ ì‚¬ëŒì…ë‹ˆë‹¤.',
    'INFP': 'ì—´ì •ì ì¸ ì¤‘ì¬ìë¡œ, ìƒëƒ¥í•˜ê³  ì´íƒ€ì ì´ë©° ë§ˆìŒì´ ë”°ëœ»í•œ ë‚­ë§Œì£¼ì˜ìì…ë‹ˆë‹¤.',
    'INTP': 'ë…¼ë¦¬ì ì¸ ì‚¬ìƒ‰ê°€ë¡œ, ëŠì„ì—†ì´ ì§€ì  í˜¸ê¸°ì‹¬ì„ ë°œíœ˜í•˜ë©° ë¶„ì„ì ì¸ ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ESTP': 'ëª¨í—˜ì„ ì¦ê¸°ëŠ” ì‚¬ì—…ê°€í˜•ìœ¼ë¡œ, ì¦‰í¥ì ì´ê³  í™œë™ì ì´ë©° ì‚¬ëŒë“¤ê³¼ ì˜ ì–´ìš¸ë¦¬ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ESFP': 'ììœ ë¡œìš´ ì˜í˜¼ì˜ ì—°ì˜ˆì¸í˜•ìœ¼ë¡œ, ì‚¬êµì ì´ê³  ì—ë„ˆì§€ê°€ ë„˜ì¹˜ë©° ì¦ê±°ì›€ì„ ì¶”êµ¬í•˜ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ENFP': 'ì¬ê¸° ë°œë„í•œ í™œë™ê°€í˜•ìœ¼ë¡œ, ìƒìƒë ¥ì´ í’ë¶€í•˜ê³  ê°œë°©ì ì´ë©° ì •ì—´ì ì¸ ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ENTP': 'ë³€ë¡ ê°€í˜•ìœ¼ë¡œ, ë…ì°½ì ì´ê³  ì§€ì ì¸ ë„ì „ì„ ì¦ê¸°ë©° ë˜‘ë˜‘í•œ ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ESTJ': 'ì‚¬ì—…ê°€í˜•ìœ¼ë¡œ, ì²´ê³„ì ì´ê³  í˜„ì‹¤ì ì´ë©° ë¦¬ë”ì‹­ì´ ë›°ì–´ë‚˜ ì¡°ì§ì„ ì˜ ì´ëŒì–´ ë‚˜ê°€ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ESFJ': 'ì‚¬êµì ì¸ ì™¸êµê´€í˜•ìœ¼ë¡œ, ì¹œì ˆí•˜ê³  ì‚¬ëŒë“¤ì„ ë•ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ë©° í—Œì‹ ì ì¸ ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ENFJ': 'ì •ì˜ë¡œìš´ ì‚¬íšŒìš´ë™ê°€í˜•ìœ¼ë¡œ, ì¹´ë¦¬ìŠ¤ë§ˆ ìˆê³  ì—´ì •ì ì´ë©° ì´íƒ€ì ì¸ ì‚¬ëŒì…ë‹ˆë‹¤.',
    'ENTJ': 'ëŒ€ë‹´í•œ í†µì†”ìí˜•ìœ¼ë¡œ, ì†”ì§í•˜ê³  ë‹¨í˜¸í•˜ë©° ë›°ì–´ë‚œ í†µì†”ë ¥ì„ ê°€ì§„ ë¦¬ë”ì…ë‹ˆë‹¤.'
}

# 2. ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬
FILE_PATH = "countriesMBTI_16types.csv"
try:
    # CSV íŒŒì¼ ë¡œë“œ
    df_raw = pd.read_csv(FILE_PATH)
    
    # êµ­ê°€ë³„ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ 16ê°€ì§€ MBTI ìœ í˜•ì˜ ì „ ì„¸ê³„ í‰ê·  ë¹„ìœ¨ ê³„ì‚°
    # 'Country' ì»¬ëŸ¼ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ì´ MBTI ìœ í˜• ë¹„ìœ¨ì…ë‹ˆë‹¤.
    mbti_percentage = df_raw.drop(columns=['Country']).mean() * 100 # í‰ê· ì„ ë‚¸ í›„ í¼ì„¼íŠ¸(%)ë¡œ ë³€í™˜
    
    # ë°ì´í„°í”„ë ˆì„ êµ¬ì¡°í™” (MBTI ìœ í˜•, ì„¤ëª…, í‰ê·  ë¹„ìœ¨)
    df_mbti = pd.DataFrame({
        'Description': pd.Series(mbti_descriptions),
        'Percentage': mbti_percentage
    }).dropna() # ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ëˆ„ë½ëœ ê°’ ì œê±°
    
    mbti_types = sorted(df_mbti.index.tolist())
    
except FileNotFoundError:
    st.error(f"ğŸš¨ '{FILE_PATH}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ í™•ì¸í•˜ê±°ë‚˜ ê²½ë¡œë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.")
    df_mbti = pd.DataFrame()
    mbti_types = []
except Exception as e:
    st.error(f"ğŸš¨ ë°ì´í„° íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
    df_mbti = pd.DataFrame()
    mbti_types = []


# 3. ë©˜íŠ¸ ìƒì„± í•¨ìˆ˜
def generate_compliment(mbti, percentage):
    """
    MBTI ìœ í˜•ê³¼ ì „ ì„¸ê³„ í‰ê·  ë¹„ìœ¨ì„ ê¸°ë°˜ìœ¼ë¡œ ê²©ë ¤ ë° íŠ¹ì§• ë©˜íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    """
    common_traits = {
        'ISTJ': "í˜„ì‹¤ì ì¸", 'ISFJ': "í—Œì‹ ì ì¸", 'INFJ': "í†µì°°ë ¥ ìˆëŠ”", 'INTJ': "ì „ëµì ì¸",
        'ISTP': "ë…¼ë¦¬ì ì¸", 'ISFP': "ì˜ˆìˆ ì ì¸", 'INFP': "ì‚¬ë ¤ ê¹Šì€", 'INTP': "ì§€ì ì¸",
        'ESTP': "í™œë™ì ì¸", 'ESFP': "ììœ ë¡œìš´", 'ENFP': "ì°½ì˜ì ì¸", 'ENTP': "ë„ì „ì ì¸",
        'ESTJ': "ì²´ê³„ì ì¸", 'ESFJ': "ì‚¬êµì ì¸", 'ENFJ': "ì´íƒ€ì ì¸", 'ENTJ': "í†µì†”ë ¥ ìˆëŠ”"
    }

    trait = common_traits.get(mbti, "ë§¤ë ¥ì ì¸")
    
    # ë¹„ìœ¨ì— ë”°ë¥¸ í†µê³„ ë©”ì‹œì§€ ë¶„ë¥˜ (ì˜ˆì‹œ ê¸°ì¤€: í‰ê·  ë¹„ìœ¨ 6.25%)
    if percentage >= 8.0:
        stat_msg = "ë¹„êµì  í”í•˜ë©° ì˜í–¥ë ¥ì´ í° ìœ í˜•"
    elif percentage >= 4.0:
        stat_msg = "ì „ ì„¸ê³„ì ìœ¼ë¡œ ê³ ë£¨ ë¶„í¬ëœ ìœ í˜•"
    else:
        stat_msg = "í¬ê·€í•œ í¸ì— ì†í•˜ëŠ” íŠ¹ë³„í•˜ê³  ê³ ìœ í•œ ìœ í˜•"

    compliment = (
        f"**âœ¨ {mbti} ìœ í˜•ì´ì‹  ë‹¹ì‹ **ì€ {trait} ë¶„ì´ì‹œêµ°ìš”! "
        f"ì „ ì„¸ê³„ ì¸êµ¬ì˜ í‰ê·  ì•½ **{percentage:.2f}%**ë¥¼ ì°¨ì§€í•˜ëŠ” {stat_msg}ì…ë‹ˆë‹¤. "
        f"ë‹¹ì‹ ì˜ ê³ ìœ í•œ ê°•ì ì„ ë§ˆìŒê» í¼ì³ë‚˜ê°€ì‹œê¸¸ ì‘ì›í•©ë‹ˆë‹¤! ğŸš€"
    )
    return compliment

# 4. Streamlit ì•± ë©”ì¸ í•¨ìˆ˜
def main():
    if df_mbti.empty:
        st.warning("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜ë¡œ ì¸í•´ ì•±ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return
        
    st.set_page_config(page_title="MBTI ì„±ê²© ìœ í˜• ë¶„ì„ê¸°", layout="centered")
    
    st.title("ğŸ§© MBTI ì„±ê²© ìœ í˜• ë¶„ì„ê¸°")
    st.markdown("---")
    
    # MBTI ìœ í˜• ë¦¬ìŠ¤íŠ¸ (ì„ íƒí•˜ì§€ ì•ŠìŒì„ í¬í•¨)
    select_prompt = '--- MBTIë¥¼ ì„ íƒí•˜ì„¸ìš” ---'
    mbti_list_for_select = [select_prompt] + mbti_types

    # ì‚¬ìš©ìì—ê²Œ MBTI ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³´ì—¬ì£¼ê¸°
    selected_mbti = st.selectbox(
        "**ğŸ‘‡ ë‹¹ì‹ ì˜ MBTIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:**",
        mbti_list_for_select,
        index=0 # ì´ˆê¸°ê°’ì€ '--- MBTIë¥¼ ì„ íƒí•˜ì„¸ìš” ---'
    )

    st.markdown("---")

    # 5. ì„ íƒ ê²°ê³¼ì— ë”°ë¥¸ í™”ë©´ ì¶œë ¥
    if selected_mbti == select_prompt:
        # ì´ˆê¸° ì ‘ì† ë˜ëŠ” ë¯¸ì„ íƒ ì‹œ ë©”ì‹œì§€
        st.info("ğŸ‘† ìœ„ì— ìˆëŠ” ë“œë¡­ë‹¤ìš´ ë©”ë‰´ì—ì„œ **ë‹¹ì‹ ì˜ MBTI**ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. ì„ íƒí•˜ì‹œë©´ í•´ë‹¹í•˜ëŠ” MBTIì— ëŒ€í•œ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤!")
        st.image("https://i.imgur.com/vHq8z4l.png", caption="16ê°€ì§€ MBTI ìœ í˜•", use_column_width=True)
        
    elif selected_mbti in df_mbti.index:
        # ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
        mbti_info = df_mbti.loc[selected_mbti]
        
        # ë°ì´í„° ì¶”ì¶œ
        description = mbti_info['Description']
        percentage = mbti_info['Percentage']
        
        st.header(f"ğŸŒŸ {selected_mbti} ìœ í˜• ë¶„ì„ ê²°ê³¼")
        
        # 5-1. MBTI ì„¤ëª… ì¶œë ¥
        st.subheader("ğŸ“ ìœ í˜• ì„¤ëª…")
        st.write(f"**{selected_mbti}** ìœ í˜•ì€ ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì§•ì„ ê°€ì§‘ë‹ˆë‹¤:")
        st.markdown(f"> **{description}**")
        
        st.markdown("---")
        
        # 5-2. í†µê³„ ì •ë³´ ì¶œë ¥ ë° ë©˜íŠ¸ ìƒì„±
        st.subheader("ğŸ“Š í†µê³„ ì •ë³´ ë° ë§ì¶¤ ë©˜íŠ¸")
        
        # ë©˜íŠ¸ ìƒì„±
        compliment_message = generate_compliment(selected_mbti, percentage)
        st.markdown(f"### {compliment_message}")
        
        st.markdown("---")
        
        # 5-3. í†µê³„ ì‹œê°í™”
        st.subheader("ğŸ“ˆ ì „ ì„¸ê³„ í‰ê·  ì¸êµ¬ ë¹„ìœ¨ ì‹œê°í™”")
        
        col1, col2 = st.columns([1, 2])
        
        with col1:
            st.metric(label=f"**{selected_mbti} í‰ê·  ë¹„ìœ¨**", value=f"{percentage:.2f}%")
        
        with col2:
            st.metric(label="ë‚˜ë¨¸ì§€ ì¸êµ¬ ë¹„ìœ¨", value=f"{100.0 - percentage:.2f}%")
        
        # ì „ì²´ MBTI ë¹„ìœ¨ì„ ì‹œê°í™”í•˜ëŠ” ë§‰ëŒ€ ê·¸ë˜í”„ (ì„ íƒëœ ìœ í˜• ê°•ì¡°)
        st.markdown("**16ê°€ì§€ MBTI ìœ í˜•ì˜ ì „ ì„¸ê³„ í‰ê·  ë¹„ìœ¨ ë¶„í¬**")
        
        # ì„ íƒëœ ìœ í˜• ê°•ì¡°ë¥¼ ìœ„í•œ ìƒ‰ìƒ ì»¬ëŸ¼ ì¶”ê°€
        df_plot = df_mbti.reset_index().rename(columns={'index': 'MBTI ìœ í˜•', 'Percentage': 'ë¹„ìœ¨ (%)'})
        df_plot['Color'] = np.where(df_plot['MBTI ìœ í˜•'] == selected_mbti, 'ì„ íƒë¨', 'ê¸°íƒ€')
        
        st.bar_chart(
            df_plot.set_index('MBTI ìœ í˜•')['ë¹„ìœ¨ (%)'],
            use_container_width=True,
            height=300
        )


# ì•± ì‹¤í–‰
if __name__ == "__main__":
    main()
